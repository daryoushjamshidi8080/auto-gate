{% extends "base.html" %}
{% load static %}



{% block title %}
    ØªÙ†Ø¸ÛŒÙ…Ø§Øª
{% endblock %}

{% block content %}


  <div class="contaner d-flex m-5 ">
    <div id="antenna-list">
      <!-- loadAntennaList() -->
    </div>

    <div id="user_list">
      <!-- loadUserList() -->
    </div>
  </div>

<div class="modal fade" id="createUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="userCreateForm" method="post">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title">Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="user-modal-body">
          <!-- Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ Ajax ÙØ±Ù… Ù„ÙˆØ¯ Ù…ÛŒØ´Ù‡ -->
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Ø«Ø¨Øª</button>
        </div>
        
      </form>
    </div>
  </div>

</div>

<div class="modal fade" id="createAntennaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="antennaCreateForm" method="post">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title">Ø§ÛŒØ¬Ø§Ø¯ Ø¢Ù†ØªÙ†</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="antenna-modal-body">
          <!-- Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ Ajax ÙØ±Ù… Ù„ÙˆØ¯ Ù…ÛŒØ´Ù‡ -->
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Ø«Ø¨Øª</button>
        </div>
      </form>
    </div>
  </div>
</div>


<div class="modal fade" id="updateAntennaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="UpdateAntennaForm" method="post">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title">Ø§ÛŒØ¬Ø§Ø¯ Ø¢Ù†ØªÙ†</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="antenna-update-modal-body">
          <!-- Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ Ajax ÙØ±Ù… Ù„ÙˆØ¯ Ù…ÛŒØ´Ù‡ -->
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Ø«Ø¨Øª</button>
        </div>
      </form>
    </div>
  </div>
</div>


  
{% endblock %}  

{% block js %}

<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> -->
<script src="{% static 'setting/css/bootstrap.bundle.min.js' %}"></script>


<script>

document.addEventListener('DOMContentLoaded', function () {
  const modal = document.getElementById('createAntennaModal');
  const modalBody = document.getElementById('antenna-modal-body');
  const form = document.getElementById('antennaCreateForm');


  const updateAntennaModal = document.getElementById('updateAntennaModal');
  const updateModalBody = document.getElementById('antenna-update-modal-body');
  const updateForm = document.getElementById('UpdateAntennaForm');

  antennaId = null;
  updateAntennaModal.addEventListener('show.bs.modal', function (e) {
    antennaId = e.relatedTarget.getAttribute('data-id');
    
    fetch(`/setting/update-antenna/${antennaId}/`)
      .then(res => res.json())
      .then(data => {
        updateModalBody.innerHTML = data.form_html;
      }).catch(err => {
        updateModalBody.innerHTML = "<p>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ±Ù…</p>";
        console.error("Error loading form:", err);
      })
  })

  updateForm.addEventListener('submit', function (e) {
    e.preventDefault();
    formData = new FormData(updateForm);
    fetch(`/setting/update-antenna/${antennaId}/`, {
      method: 'POST',
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        if (data.status === 200) {
          bsModal = bootstrap.Modal.getInstance(updateAntennaModal);
          bsModal.hide();
          updateForm.reset();
          alert("âœ… Ø¢Ù†ØªÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯!");
          loadAntennaList();

        }else{
          alert("âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ù†ØªÙ†");
          loadAntennaList()
        }
      }).catch(err => {
        updateModalBody.innerHTML = "<p>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ±Ù…</p>";
        console.error("Error loading form:", err);
      })
  })





  const antennaListDiv = document.getElementById('antenna-list');

  // AJAX load antenna list
  function loadAntennaList() {
    fetch("{% url 'setting:antenna_list_partial' %}")
      .then(res => res.json())
      .then(data => {
        antennaListDiv.innerHTML = data.html;
      })
      .catch(err => {
        antennaListDiv.innerHTML = "<p>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø¢Ù†ØªÙ†â€ŒÙ‡Ø§</p>";
        console.error("Error loading antenna list:", err);
      });
  }

  

  loadAntennaList();// load antenna list

  window.loadAntennaList = loadAntennaList;// load antenna list

  // AJAX load antenna form
  modal.addEventListener('show.bs.modal', function () {
    fetch("{% url 'setting:create_antenna' %}")
      .then(res => res.json())
      .then(data => {
        modalBody.innerHTML = data.form_html;
      });
  });


  // AJAX create antenna
  form.addEventListener('submit', function (e) {
    e.preventDefault();


    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    console.log("csrf input:", csrfInput);

    const formData = new FormData(form);
    fetch("{% url 'setting:create_antenna' %}", {
      method: 'POST',
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const bsModal = bootstrap.Modal.getInstance(modal);
          bsModal.hide();
          form.reset();
          alert("âœ… Ø¢Ù†ØªÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!"); //create antenna
          loadAntennaList();

          fetch("/rfid/start-thread/",
            {
              method: "POST"
            }
            )
            .then(res => res.json())
            .then(data => {
              // console.log("ğŸ“¦ Response from /rfid/start-thread/:", data);
              if(data.success){
                console.log(' âœ… RFID thread restarted with new antenna')
              }else{
                console.error('âŒ Failed to restart RFID thread.')
              }
            }).catch(err => {
              console.error('âŒ Error sending start-thread request:', err)
            })
          

          window.loadAntennaList = loadAntennaList;
        } else {
          modalBody.innerHTML = data.form_html;
        }
      });
  });



  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  const userListDiv = document.getElementById('user_list');


  // AJAX load user list
  function loadUserList() {
    fetch("{% url 'setting:user_list_partial' %}")
      .then(res => res.json())
      .then(data => {
        userListDiv.innerHTML = data.html;

      })
      .catch(err => {
        userListDiv.innerHTML = "<p>âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>";
        console.error("Error loading user list:", err);
      });
  }

  loadUserList();// load user list
  window.loadUserList = loadUserList;// load user list


  const modalUser = document.getElementById('createUserModal');
  const modalBodyUser = document.getElementById('user-modal-body');
  const formUser = document.getElementById('userCreateForm');

  // AJAX load user form
  modalUser.addEventListener('show.bs.modal', function () {
    fetch("{% url 'setting:create_user' %}")
      .then(res => res.json())
      .then(data => {
        modalBodyUser.innerHTML = data.form_html;
      });
  });


  // AJAX create user
  formUser.addEventListener('submit', function (e) {
    e.preventDefault();

    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]').value;
    console.log("csrf input:", csrfInput);

    const formData = new FormData(formUser);
    fetch("{% url 'setting:create_user' %}", {
      method: 'POST',
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const bsModal = bootstrap.Modal.getInstance(modalUser);
          bsModal.hide();
          formUser.reset();
          alert("âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!");
          loadUserList();
          window.loadUserList = loadUserList;
        } else {
          modalBodyUser.innerHTML = data.form_html;
        }
      });
  })

});



document.addEventListener('click', function (e) {

  if (e.target.classList.contains('delete-user')) {
    const userId = e.target.getAttribute('data-id');

    if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ")) {
      fetch(`/setting/delete-user/${userId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯!");
          loadUserList();  // âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ø¨Ø¯ÙˆÙ† Ø±ÙØ±Ø´
        } else {
          alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±");
        }
      })
    }
  }
  if (e.target.classList.contains('delete-antenna')) 
  {
    const antennaId = e.target.getAttribute('data-id');
    const antennaAdder = e.target.getAttribute('data-adder')
    const antennaName = e.target.getAttribute('data-name')
    console.log('id annten : ' , antennaAdder)



    if (confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ø¢Ù†ØªÙ† Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ")) 
    {
      fetch(`/setting/delete-antenna/${antennaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
        .then(res => res.json())
        .then(data => {
          
          if (data.success) {
            alert("âœ… Ø¢Ù†ØªÙ† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯!");
            loadAntennaList();  // âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ø¨Ø¯ÙˆÙ† Ø±ÙØ±Ø´

            
            console.log('pert')
            fetch('/rfid/stop-thread/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({antennaName, antennaAdder})
            })
            .then(res => res.json())
            .then(data => {
              console.log('data :', data)
              if(data.success){
                console.log('Success delete antena ')
              }else{
                console.error(' wrong delete anntea')
              }
            }).catch(err => {
              console.error('error delete : ', err)
            })

          } else {
            alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢Ù†ØªÙ†");
          }
        });
    }
  }
});

  


  setInterval(() => {
    window.loadAntennaList()
  }, 2000)


</script>

{% endblock %}